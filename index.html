<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>„Åæ„ÅÑ„Å´„Å°„ÅÆ„Åä„ÇÑ„Åè„Åù„Åè„ÉÅ„Çß„ÉÉ„ÇØÔºÅ</title>
  <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    :root{
      --primary:#FF6B9D;
      --secondary:#FFA07A;
      --success:#4ECDC4;
      --warning:#FFD93D;
      --purple:#A78BFA;
      --blue:#60A5FA;
      --bg:#FFF8E7;
      --card-bg:#FFFFFF;
      --shadow:rgba(255,107,157,0.2);
      --neutral:#CBD5E1;
      --neutral-text:#334155;
    }
    body{
      font-family:'M PLUS Rounded 1c',sans-serif;
      background:linear-gradient(135deg,#FFF8E7 0%,#FFE5EC 50%,#E5F3FF 100%);
      min-height:100vh;
      padding:20px;
      position:relative;
      overflow-x:hidden;
    }
    body::before{
      content:'';
      position:fixed;
      top:-50%; left:-50%;
      width:200%; height:200%;
      background:
        radial-gradient(circle at 20% 50%, rgba(255,107,157,0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(78,205,196,0.1) 0%, transparent 50%),
        radial-gradient(circle at 40% 20%, rgba(160,139,250,0.1) 0%, transparent 50%);
      animation:float 20s ease-in-out infinite;
      pointer-events:none;
      z-index:0;
    }
    @keyframes float{
      0%,100%{transform:translate(0,0) rotate(0deg);}
      33%{transform:translate(30px,-30px) rotate(5deg);}
      66%{transform:translate(-20px,20px) rotate(-5deg);}
    }
    .container{ max-width:900px; margin:0 auto; position:relative; z-index:1; }
    .login-container{
      max-width:450px;
      margin:80px auto;
      background:var(--card-bg);
      padding:45px;
      border-radius:30px;
      box-shadow:0 15px 50px var(--shadow);
      border:4px solid var(--primary);
      animation:fadeIn 0.6s ease-out;
    }
    @keyframes fadeIn{ from{opacity:0; transform:scale(0.95);} to{opacity:1; transform:scale(1);} }
    .login-header{ text-align:center; margin-bottom:30px; }
    .login-header .emoji{ font-size:5rem; animation:bounce 2s ease-in-out infinite; }
    .login-header h2{ font-size:2rem; font-weight:900; color:var(--primary); margin-top:10px; }
    @keyframes bounce{
      0%,100%{transform:translateY(0) rotate(0deg);}
      25%{transform:translateY(-10px) rotate(-5deg);}
      75%{transform:translateY(-5px) rotate(5deg);}
    }
    .form-group{ margin-bottom:18px; }
    .form-group label{ display:block; font-size:1.1rem; font-weight:800; color:#333; margin-bottom:8px; }
    .form-group input{
      width:100%;
      padding:14px 18px;
      border:3px solid var(--success);
      border-radius:15px;
      font-size:1.05rem;
      font-family:'M PLUS Rounded 1c',sans-serif;
      font-weight:800;
      transition:all 0.25s ease;
    }
    .form-group input:focus{
      outline:none;
      border-color:var(--primary);
      box-shadow:0 0 0 4px rgba(255,107,157,0.2);
      transform:scale(1.01);
    }
    .login-btn{
      width:100%;
      padding:16px;
      background:linear-gradient(135deg,var(--primary),var(--purple));
      color:white;
      border:none;
      border-radius:15px;
      font-size:1.25rem;
      font-weight:900;
      font-family:'M PLUS Rounded 1c',sans-serif;
      cursor:pointer;
      transition:all 0.25s ease;
      box-shadow:0 5px 20px rgba(255,107,157,0.4);
      margin-top:8px;
    }
    .login-btn:hover{ transform:translateY(-2px); box-shadow:0 8px 25px rgba(255,107,157,0.5); }
    .error-message{ color:#ff4444; font-weight:800; text-align:center; margin-top:12px; display:none; }

    .user-info{
      display:flex; justify-content:space-between; align-items:center;
      background:var(--card-bg);
      padding:14px 22px;
      border-radius:15px;
      margin-bottom:18px;
      box-shadow:0 5px 20px var(--shadow);
      border:3px solid var(--success);
      flex-wrap:wrap;
      gap:10px;
    }
    .user-name{ font-size:1.2rem; font-weight:800; color:var(--primary); }
    .user-buttons{ display:flex; gap:10px; flex-wrap:wrap; }
    .logout-btn,.home-btn,.reset-btn{
      padding:10px 18px;
      border:none; border-radius:10px;
      font-size:1rem; font-weight:800;
      font-family:'M PLUS Rounded 1c',sans-serif;
      cursor:pointer;
      transition:all 0.25s ease;
    }
    .logout-btn{ background:var(--warning); color:#333; }
    .logout-btn:hover{ transform:scale(1.04); box-shadow:0 3px 10px rgba(255,215,61,0.5); }
    .home-btn{ background:linear-gradient(135deg,var(--purple),var(--blue)); color:white; }
    .home-btn:hover{ transform:scale(1.04); box-shadow:0 3px 10px rgba(160,139,250,0.5); }
    .reset-btn{ background:linear-gradient(135deg,#94A3B8,#CBD5E1); color:#0f172a; }
    .reset-btn:hover{ transform:scale(1.04); box-shadow:0 3px 10px rgba(148,163,184,0.5); }

    .header{ text-align:center; margin:22px 0 24px; }
    .header .emoji{ font-size:4rem; display:inline-block; animation:bounce 2s ease-in-out infinite; }
    .header h1{
      font-size:2.6rem; font-weight:900;
      background:linear-gradient(135deg,var(--primary),var(--purple),var(--success));
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      margin-top:8px;
    }
    .date-display{
      background:var(--card-bg);
      padding:18px;
      border-radius:20px;
      box-shadow:0 8px 30px var(--shadow);
      margin-bottom:24px;
      display:flex; justify-content:space-between; align-items:center;
      font-size:1.3rem; font-weight:800; color:var(--primary);
      border:3px solid var(--warning);
    }
    .date-nav-btn{
      padding:10px 16px;
      background:linear-gradient(135deg,var(--success),var(--blue));
      color:white;
      border:none; border-radius:15px;
      font-size:0.95rem; font-weight:800;
      font-family:'M PLUS Rounded 1c',sans-serif;
      cursor:pointer;
      transition:all 0.25s ease;
      box-shadow:0 3px 10px rgba(78,205,196,0.3);
    }
    .date-nav-btn:hover{ transform:translateY(-2px); box-shadow:0 5px 15px rgba(78,205,196,0.4); }
    .date-nav-btn:disabled{ opacity:0.5; cursor:not-allowed; }
    .current-date{ flex:1; text-align:center; }

    .checklist-card{
      background:var(--card-bg);
      padding:26px;
      border-radius:25px;
      box-shadow:0 10px 40px var(--shadow);
      margin-bottom:22px;
      border:4px solid var(--success);
    }
    .checklist-item{
      display:flex; align-items:center; justify-content:space-between;
      padding:18px; margin-bottom:12px;
      border-radius:15px;
      background:linear-gradient(135deg, rgba(255,107,157,0.05), rgba(78,205,196,0.05));
      border:2px solid transparent;
      transition:all 0.25s ease;
    }
    .checklist-item:hover{ transform:translateX(4px); border-color:var(--primary); box-shadow:0 5px 15px rgba(255,107,157,0.2); }
    .checklist-item.checked-yes{ background:linear-gradient(135deg, rgba(78,205,196,0.2), rgba(96,165,250,0.2)); border-color:var(--success); }
    .checklist-item.checked-no{ background:linear-gradient(135deg, rgba(255,215,61,0.2), rgba(255,160,122,0.2)); border-color:var(--warning); }
    .item-question{ font-size:1.18rem; font-weight:800; color:#333; flex:1; }
    .item-buttons{ display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; }

    .check-btn{
      padding:11px 18px;
      border:none; border-radius:50px;
      font-size:1.02rem; font-weight:800;
      font-family:'M PLUS Rounded 1c',sans-serif;
      cursor:pointer;
      transition:all 0.25s ease;
      box-shadow:0 4px 15px rgba(0,0,0,0.1);
      white-space:nowrap;
    }
    .check-btn:hover{ transform:translateY(-2px) scale(1.03); box-shadow:0 6px 20px rgba(0,0,0,0.2); }
    .btn-yes{ background:linear-gradient(135deg,var(--success),var(--blue)); color:white; }
    .btn-yes.selected{ background:var(--success); box-shadow:0 0 0 4px rgba(78,205,196,0.3); }
    .btn-no{ background:linear-gradient(135deg,var(--warning),var(--secondary)); color:#333; }
    .btn-no.selected{ background:var(--warning); box-shadow:0 0 0 4px rgba(255,215,61,0.3); }
    .btn-clear{ background:linear-gradient(135deg,var(--neutral),#E2E8F0); color:var(--neutral-text); }
    .btn-clear.selected{ background:#E2E8F0; box-shadow:0 0 0 4px rgba(203,213,225,0.7); }

    .celebrate{ animation:celebrate 0.6s ease-out; }
    @keyframes celebrate{
      0%,100%{transform:scale(1);}
      25%{transform:scale(1.07) rotate(-4deg);}
      75%{transform:scale(1.07) rotate(4deg);}
    }

    .stats-card{
      background:var(--card-bg);
      padding:26px;
      border-radius:25px;
      box-shadow:0 10px 40px var(--shadow);
      border:4px solid var(--purple);
    }
    .stats-card h2{ font-size:1.9rem; font-weight:900; color:var(--purple); margin-bottom:18px; text-align:center; }
    .stats-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));
      gap:18px;
      margin-bottom:20px;
    }
    .stat-item{
      text-align:center;
      padding:18px;
      border-radius:15px;
      background:linear-gradient(135deg, rgba(160,139,250,0.1), rgba(255,107,157,0.1));
      border:2px solid var(--purple);
    }
    .stat-value{
      font-size:2.7rem; font-weight:900;
      background:linear-gradient(135deg,var(--primary),var(--purple));
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      margin-bottom:4px;
    }
    .stat-label{ font-size:1.05rem; font-weight:800; color:#666; }
    .progress-bar-container{
      margin-top:10px;
      padding:18px;
      background:rgba(255,255,255,0.5);
      border-radius:15px;
    }
    .progress-label{ font-size:1.1rem; font-weight:800; color:#333; margin-bottom:8px; }
    .progress-bar{
      height:38px;
      background:rgba(200,200,200,0.3);
      border-radius:20px;
      overflow:hidden;
      position:relative;
      box-shadow:inset 0 2px 5px rgba(0,0,0,0.1);
    }
    .progress-fill{
      height:100%;
      background:linear-gradient(90deg,var(--success),var(--blue),var(--purple));
      border-radius:20px;
      transition:width 0.7s ease;
      display:flex; align-items:center; justify-content:center;
      color:white; font-weight:900; font-size:1.1rem;
      box-shadow:0 2px 10px rgba(78,205,196,0.5);
    }
    .trophy{ font-size:2.8rem; text-align:center; margin:16px 0; animation:spin 2s ease-in-out infinite; }
    @keyframes spin{
      0%,100%{transform:rotate(0deg) scale(1);}
      50%{transform:rotate(10deg) scale(1.07);}
    }

    .history-table{ width:100%; border-collapse:separate; border-spacing:0 10px; }
    .history-table th{
      background:linear-gradient(135deg,var(--primary),var(--purple));
      color:white;
      padding:13px;
      font-weight:900;
      font-size:1rem;
      border-radius:10px;
      white-space:nowrap;
    }
    .history-table td{
      background:rgba(255,255,255,0.85);
      padding:12px;
      text-align:center;
      font-weight:800;
      border-bottom:2px solid rgba(160,139,250,0.2);
      white-space:nowrap;
    }
    .history-table tr:hover td{ background:rgba(160,139,250,0.1); }
    .check-mark{ font-size:1.4rem; }
    .check-mark.yes{ color:var(--success); }
    .check-mark.no{ color:var(--warning); }
    .date-cell{
      cursor:pointer;
      transition:all 0.2s ease;
      font-weight:900;
    }
    .date-cell:hover{
      background:rgba(255,107,157,0.2);
      transform:scale(1.04);
      color:var(--primary);
    }

    .hidden{ display:none !important; }

    /* Modal */
    .modal-overlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,0.7);
      display:flex; justify-content:center; align-items:center;
      z-index:1000;
      animation:fadeIn 0.25s ease;
    }
    .modal-content{
      background:var(--card-bg);
      padding:28px;
      border-radius:25px;
      max-width:650px;
      width:92%;
      max-height:80vh;
      overflow-y:auto;
      box-shadow:0 20px 60px rgba(0,0,0,0.3);
      border:4px solid var(--primary);
    }
    .modal-header{ text-align:center; margin-bottom:18px; }
    .modal-header h2{ font-size:1.8rem; font-weight:900; color:var(--primary); margin-bottom:6px; }
    .modal-date{ font-size:1.2rem; font-weight:800; color:var(--purple); }
    .modal-checklist-item{
      display:flex; flex-direction:column;
      padding:16px;
      margin-bottom:12px;
      border-radius:15px;
      background:linear-gradient(135deg, rgba(255,107,157,0.05), rgba(78,205,196,0.05));
      border:2px solid transparent;
    }
    .modal-checklist-item.checked-yes{
      background:linear-gradient(135deg, rgba(78,205,196,0.2), rgba(96,165,250,0.2));
      border-color:var(--success);
    }
    .modal-checklist-item.checked-no{
      background:linear-gradient(135deg, rgba(255,215,61,0.2), rgba(255,160,122,0.2));
      border-color:var(--warning);
    }
    .modal-item-question{ font-size:1.1rem; font-weight:800; color:#333; margin-bottom:12px; }
    .modal-item-buttons{ display:flex; gap:10px; flex-wrap:wrap; }
    .close-modal-btn{
      width:100%;
      padding:14px;
      background:var(--purple);
      color:white;
      border:none;
      border-radius:15px;
      font-size:1.15rem;
      font-weight:800;
      font-family:'M PLUS Rounded 1c',sans-serif;
      cursor:pointer;
      margin-top:10px;
      transition:all 0.25s ease;
    }
    .close-modal-btn:hover{ transform:translateY(-2px); box-shadow:0 5px 20px rgba(160,139,250,0.4); }

    @media (max-width: 768px){
      .header h1{ font-size:2rem; }
      .item-question{ font-size:1.05rem; }
      .check-btn{ padding:10px 14px; font-size:0.92rem; }
      .login-container{ margin:50px 12px; padding:28px; }
      .modal-item-buttons{ flex-direction:column; }
      .item-buttons{ justify-content:flex-start; }
    }
  </style>
</head>
<body>

  <!-- Login ScreenÔºàÁ´ØÊú´ÂÜÖ„Å†„Åë„ÅÆÁ∞°Êòì„É≠„Ç∞„Ç§„É≥ÔºöË®òÈå≤„ÅØÂêå„ÅòÁ´ØÊú´„Å´‰øùÂ≠òÔºâ -->
  <div id="loginScreen" class="login-container">
    <div class="login-header">
      <div class="emoji">üîê</div>
      <h2>„É≠„Ç∞„Ç§„É≥</h2>
    </div>
    <div class="form-group">
      <label for="loginName">„Å™„Åæ„Åà</label>
      <input type="text" id="loginName" autocomplete="username">
    </div>
    <div class="form-group">
      <label for="loginDob">ÁîüÂπ¥ÊúàÊó•Ôºà8„Åë„ÅüÔºâ</label>
      <input type="password" id="loginDob" inputmode="numeric" autocomplete="current-password">
    </div>

    <button class="login-btn" id="loginButton">„É≠„Ç∞„Ç§„É≥</button>
    <div class="error-message" id="loginError">„Å™„Åæ„Åà„ÅãÁîüÂπ¥ÊúàÊó•„Åå„Å°„Åå„ÅÑ„Åæ„Åô</div>
  </div>

  <!-- Main App -->
  <div class="container hidden" id="mainApp">
    <div class="user-info">
      <div class="user-name">üë§ <span id="displayName"></span>„Åï„Çì</div>
      <div class="user-buttons">
        <button class="home-btn" onclick="goToToday()">üè† „Åç„Çá„ÅÜ„Å´„ÇÇ„Å©„Çã</button>
        <button class="reset-btn" onclick="resetAllData()">üßπ „Åú„Çì„Å∂„Åë„Åô</button>
        <button class="logout-btn" onclick="logout()">„É≠„Ç∞„Ç¢„Ç¶„Éà</button>
      </div>
    </div>

    <div class="header">
      <div class="emoji">üåü</div>
      <h1>„Åæ„ÅÑ„Å´„Å°„ÅÆ„Åä„ÇÑ„Åè„Åù„Åè„ÉÅ„Çß„ÉÉ„ÇØÔºÅ</h1>
    </div>

    <div class="date-display">
      <button class="date-nav-btn" onclick="changeDate(-1)">‚óÄ „Åæ„Åà„ÅÆÊó•</button>
      <div class="current-date" id="dateDisplay">üìÖ </div>
      <button class="date-nav-btn" onclick="changeDate(1)" id="nextDayBtn">„Å§„Åé„ÅÆÊó• ‚ñ∂</button>
    </div>

    <div class="checklist-card">
      <div id="checklist"></div>
    </div>

    <div class="stats-card">
      <h2>üìä „Åì„Çì„Åó„ÇÖ„ÅÜ„ÅÆ„Åå„Çì„Å∞„Çä</h2>

      <div class="stats-grid">
        <div class="stat-item">
          <div class="stat-value" id="weeklyPercentage">0%</div>
          <div class="stat-label">„Åß„Åç„Åü„Çä„Å§</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="todayCount">0/7</div>
          <div class="stat-label">„Åç„Çá„ÅÜ„ÅÆ„Çπ„Ç≥„Ç¢</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="weekStreak">0</div>
          <div class="stat-label">„Çå„Çì„Åû„Åè„Å´„Å£„Åô„ÅÜ</div>
        </div>
      </div>

      <div class="progress-bar-container">
        <div class="progress-label">„Åì„Çì„Åó„ÇÖ„ÅÜ„ÅÆ„Åü„Å£„Åõ„ÅÑ„Çä„Å§</div>
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill" style="width:0%;">0%</div>
        </div>
      </div>

      <div id="trophyDisplay"></div>

      <h3 style="margin-top: 24px; margin-bottom: 12px; color: var(--purple); font-size: 1.4rem; text-align: center;">
        üìÖ „Åì„Çì„Åó„ÇÖ„ÅÜ„ÅÆ„Åç„Çç„ÅèÔºàÊó•„Å•„Åë„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶„Å´„ÇÖ„ÅÜ„Çä„Çá„Åè„Éª„Åó„ÇÖ„ÅÜ„Åõ„ÅÑÔºâ
      </h3>
      <div style="overflow-x:auto;">
        <table class="history-table" id="historyTable">
          <thead>
            <tr id="historyHeaderRow"></tr>
          </thead>
          <tbody id="historyBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Date Edit Modal -->
  <div id="dateModal" class="modal-overlay hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h2>üìù „ÉÅ„Çß„ÉÉ„ÇØ„É™„Çπ„Éà</h2>
        <div class="modal-date" id="modalDate"></div>
      </div>
      <div id="modalChecklist"></div>
      <button class="close-modal-btn" onclick="closeModal()">„Å®„Åò„Çã</button>
    </div>
  </div>

<script>
  /** =========================
   *  GitHub PagesÁâàÔºàÁ´ØÊú´ÂÜÖ‰øùÂ≠ò: localStorageÔºâ
   *  - Ë®òÈå≤„ÅØ„Åì„ÅÆÁ´ØÊú´„ÅÆ„Éñ„É©„Ç¶„Ç∂„Å´ÊÆã„Çä„Åæ„Åô
   * ========================= */

  // localStorage keys
  const STORE_KEY = 'habit_single_user_store_v1';
  const AUTH_KEY  = 'habit_single_user_auth_v1';

  // ‚òÖÈ†ÖÁõÆ7„Å§
  const questions = [
    { id: 'toilet',    text: '„Åä„Åç„Åü„Çâ„Éà„Ç§„É¨„Å´Ë°å„Å£„ÅüÔºü',     yes: '„ÅÑ„Å£„ÅüÔºÅ',       no: '„Çè„Åô„Çå„Åü' },
    { id: 'change',    text: 'ÁùÄ„Åå„Åà„ÅüÔºü',                   yes: '„Åç„Åå„Åà„ÅüÔºÅ',     no: '„Åß„Åç„Å™„Åã„Å£„Åü' },
    { id: 'breakfast', text: 'Êúù„Åî„ÅØ„Çì„ÅØÊôÇÈñì„Åæ„Åß„Å´„Åü„Åπ„ÅüÔºü', yes: '„Åü„Åπ„ÅüÔºÅ',       no: '„Åü„Åπ„Çâ„Çå„Å™„Åã„Å£„Åü' },
    { id: 'study',     text: 'ÊúùÂ≠¶Áøí„ÅØ„Åå„Çì„Å∞„Å£„ÅüÔºü',         yes: '„Åå„Çì„Å∞„Å£„ÅüÔºÅ',   no: '„Åß„Åç„Å™„Åã„Å£„Åü' },
    { id: 'jungle',    text: '„Ç∏„É£„É≥„Ç∞„É´„Ç∏„É†„ÅØ„Åä„Çä„ÅüÔºü',     yes: '„Åä„Çä„ÅüÔºÅ',       no: '„Åä„Çä„Å™„Åã„Å£„Åü' },
    { id: 'teacher',   text: 'ÂÖàÁîü„ÅÆ„ÅäË©±„ÅØ„Åç„ÅÑ„ÅüÔºü',         yes: '„Åç„ÅÑ„ÅüÔºÅ',       no: '„Åß„Åç„Å™„Åã„Å£„Åü' },
    { id: 'friends',   text: '„ÅäÂèã„Å†„Å°„Å´„ÇÑ„Åï„Åó„Åè„Åß„Åç„ÅüÔºü',   yes: '„Åß„Åç„ÅüÔºÅ',       no: '„Åß„Åç„Å™„Åã„Å£„Åü' }
  ];

  let audioContext;
  let currentUserName = null;
  let currentUserDob = null;
  let selectedDate = null;
  let currentViewDate = null;

  // ===== Sound =====
  function initAudio() {
    if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
  }
  function playSuccessSound() {
    initAudio();
    const now = audioContext.currentTime;
    const freqs = [523.25, 659.25, 783.99, 1046.50];
    freqs.forEach((f, i) => {
      const o = audioContext.createOscillator();
      const g = audioContext.createGain();
      o.connect(g); g.connect(audioContext.destination);
      o.type = 'sine';
      o.frequency.setValueAtTime(f, now + i*0.08);
      g.gain.setValueAtTime(0.14, now + i*0.08);
      g.gain.exponentialRampToValueAtTime(0.01, now + i*0.08 + 0.28);
      o.start(now + i*0.08);
      o.stop(now + i*0.08 + 0.28);
    });
  }
  function playSadSound() {
    initAudio();
    const o = audioContext.createOscillator();
    const g = audioContext.createGain();
    o.connect(g); g.connect(audioContext.destination);
    o.type='sine';
    const now = audioContext.currentTime;
    o.frequency.setValueAtTime(392.00, now);
    o.frequency.setValueAtTime(349.23, now + 0.15);
    o.frequency.setValueAtTime(293.66, now + 0.30);
    g.gain.setValueAtTime(0.18, now);
    g.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
    o.start(now); o.stop(now + 0.5);
  }

  // ===== UI helpers =====
  function showError(msg) {
    const el = document.getElementById('loginError');
    el.textContent = msg;
    el.style.display = 'block';
    setTimeout(() => el.style.display = 'none', 3000);
  }

  function getToday() {
    const t = new Date();
    const y = t.getFullYear();
    const m = String(t.getMonth() + 1).padStart(2, '0');
    const d = String(t.getDate()).padStart(2, '0');
    return `${y}-${m}-${d}`;
  }
  function formatDate(dateStr) {
    const date = new Date(dateStr + 'T00:00:00');
    const month = date.getMonth() + 1;
    const day = date.getDate();
    const days = ['Êó•','Êúà','ÁÅ´','Ê∞¥','Êú®','Èáë','Âúü'];
    return `${month}Êúà${day}Êó•Ôºà${days[date.getDay()]}Ôºâ`;
  }

  // ===== localStorage store =====
  function safeParseJSON(text, fallback) {
    try {
      const parsed = JSON.parse(text);
      return (parsed && typeof parsed === 'object') ? parsed : fallback;
    } catch {
      return fallback;
    }
  }

  function loadStore() {
    const raw = localStorage.getItem(STORE_KEY);
    return raw ? safeParseJSON(raw, {}) : {};
  }
  function saveStore(store) {
    localStorage.setItem(STORE_KEY, JSON.stringify(store));
  }

  function loadAuth() {
    const raw = localStorage.getItem(AUTH_KEY);
    return raw ? safeParseJSON(raw, null) : null;
  }
  function saveAuth(name, dob) {
    localStorage.setItem(AUTH_KEY, JSON.stringify({ name, dob }));
  }
  function clearAuth() {
    localStorage.removeItem(AUTH_KEY);
  }

  // ===== ‚ÄúË™çË®º‚Äù =====
  // GitHub PagesÁâà„ÅØ„Çµ„Éº„Éê„ÉºË™çË®º„Åß„Åç„Å™„ÅÑ„ÅÆ„Åß„ÄÅÁ´ØÊú´ÂÜÖ„Å†„Åë„ÅÆÁ∞°Êòì„É≠„Ç∞„Ç§„É≥„Åß„Åô„ÄÇ
  // „Åì„Åì„Åß„ÅØ„ÄåÁ©∫„Åß„Å™„Åë„Çå„Å∞OK„Äç„Å´„Åó„Å¶„ÄÅÂÖ•ÂäõÂÄ§„ÅØÁ´ØÊú´ÂÜÖ„Å´„Å†„Åë‰øùÂ≠ò„Åó„Åæ„Åô„ÄÇ
  function isAuthorizedLocal(name, dob) {
    return !!name && /^\d{8}$/.test(dob);
  }

  // ===== Data APIs (local) =====
  async function apiAuth(name, dob) {
    return isAuthorizedLocal(name, dob);
  }
  async function apiGetDay(date) {
    const store = loadStore();
    return store[date] || {};
  }
  async function apiSetDay(date, data) {
    const store = loadStore();
    store[date] = data;
    saveStore(store);
    return true;
  }
  async function apiGetAll() {
    return loadStore();
  }

  // ===== Checklist render =====
  function computeRowClass(v){
    if (v === true) return 'checked-yes';
    if (v === false) return 'checked-no';
    return '';
  }

  async function renderChecklist() {
    const data = await apiGetDay(currentViewDate);
    const checklistDiv = document.getElementById('checklist');

    checklistDiv.innerHTML = questions.map(q => {
      const v = data[q.id];
      return `
      <div class="checklist-item ${computeRowClass(v)}" id="item-${q.id}">
        <div class="item-question">${q.text}</div>
        <div class="item-buttons">
          <button class="check-btn btn-yes ${v === true ? 'selected' : ''}" onclick="handleCheck('${q.id}', true)">${q.yes}</button>
          <button class="check-btn btn-no  ${v === false ? 'selected' : ''}" onclick="handleCheck('${q.id}', false)">${q.no}</button>
          <button class="check-btn btn-clear ${v === undefined ? 'selected' : ''}" onclick="handleCheck('${q.id}', null)">„Å®„Çä„Åë„Åô</button>
        </div>
      </div>`;
    }).join('');
  }

  async function handleCheck(questionId, value) {
    const item = document.getElementById(`item-${questionId}`);
    if (item && item.classList.contains('celebrate')) return;

    if (value === true) playSuccessSound();
    else if (value === false) playSadSound();

    if (item) {
      item.classList.add('celebrate');
      setTimeout(() => item.classList.remove('celebrate'), 600);
    }

    const data = await apiGetDay(currentViewDate);

    if (value === null) {
      delete data[questionId]; // Êú™ÂõûÁ≠î„Å´Êàª„Åô
    } else {
      data[questionId] = value;
    }

    await apiSetDay(currentViewDate, data);

    await renderChecklist();
    await updateStats();
  }

  // ===== Week stats =====
  async function getWeekDates() {
    const today = new Date();
    const dow = today.getDay();
    const daysSinceMonday = (dow === 0) ? 6 : (dow - 1);

    const dates = [];
    for (let i = daysSinceMonday; i >= 0; i--) {
      const d = new Date(today);
      d.setDate(d.getDate() - i);
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      dates.push(`${y}-${m}-${dd}`);
    }
    return dates;
  }

  function calculateStats(weekData) {
    let totalChecks = 0;
    let yesChecks = 0;
    let streak = 0;
    let currentStreak = 0;

    [...weekData].reverse().forEach(day => {
      const data = day.data;
      if (data && Object.keys(data).length > 0) {
        let dayYes = 0;
        let answered = 0;

        questions.forEach(q => {
          if (data[q.id] !== undefined) {
            totalChecks++;
            answered++;
            if (data[q.id] === true) {
              yesChecks++;
              dayYes++;
            }
          }
        });

        if (answered === questions.length && dayYes === questions.length) {
          currentStreak++;
          streak = Math.max(streak, currentStreak);
        } else {
          currentStreak = 0;
        }
      }
    });

    const percentage = totalChecks > 0 ? Math.round((yesChecks / totalChecks) * 100) : 0;
    return { percentage, streak };
  }

  async function updateStats() {
    const all = await apiGetAll();
    const weekDates = await getWeekDates();

    const weekData = weekDates.map(date => ({ date, data: all[date] || null }));
    const stats = calculateStats(weekData);

    const todayStr = getToday();
    const todayData = all[todayStr] || {};
    const todayYes = questions.filter(q => todayData[q.id] === true).length;

    document.getElementById('weeklyPercentage').textContent = `${stats.percentage}%`;
    document.getElementById('todayCount').textContent = `${todayYes}/${questions.length}`;
    document.getElementById('weekStreak').textContent = `${stats.streak}`;

    const progressFill = document.getElementById('progressFill');
    progressFill.style.width = `${stats.percentage}%`;
    progressFill.textContent = `${stats.percentage}%`;

    const trophyDisplay = document.getElementById('trophyDisplay');
    if (stats.percentage >= 80) trophyDisplay.innerHTML = '<div class="trophy">üèÜ „Åô„Åî„ÅÑÔºÅ„Çà„Åè„Åå„Çì„Å∞„Å£„Åü„Å≠ÔºÅ</div>';
    else if (stats.percentage >= 60) trophyDisplay.innerHTML = '<div class="trophy">‚≠ê „ÅÑ„ÅÑ„Å°„Çá„ÅÜ„Åó„Å†„Å≠ÔºÅ</div>';
    else trophyDisplay.innerHTML = '<div class="trophy">üí™ „Åå„Çì„Å∞„Çç„ÅÜÔºÅ</div>';

    renderHistoryHeader();
    renderHistory(weekData);
  }

  function renderHistoryHeader() {
    const row = document.getElementById('historyHeaderRow');
    const headers = ['Êó•„Å•„Åë', ...questions.map(q => {
      if (q.id === 'toilet') return '„Éà„Ç§„É¨';
      if (q.id === 'change') return 'ÁùÄ„Åå„Åà';
      if (q.id === 'breakfast') return '„ÅÇ„Åï„Åî„ÅØ„Çì';
      if (q.id === 'study') return '„ÅÇ„Åï„Åå„Åè„Åó„ÇÖ„ÅÜ';
      if (q.id === 'jungle') return '„Ç∏„É£„É≥„Ç∞„É´„Ç∏„É†';
      if (q.id === 'teacher') return '„Åä„ÅØ„Å™„Åó';
      if (q.id === 'friends') return '„Åä„Å®„ÇÇ„Å†„Å°';
      return q.id;
    })];
    row.innerHTML = headers.map(h => `<th>${h}</th>`).join('');
  }

  function renderHistory(weekData) {
    const tbody = document.getElementById('historyBody');
    tbody.innerHTML = weekData.map(day => {
      const cells = questions.map(q => {
        const v = day.data ? day.data[q.id] : undefined;
        if (v === undefined) return `<td>-</td>`;
        return `<td><span class="check-mark ${v ? 'yes' : 'no'}">${v ? '‚≠ï' : '‚ùå'}</span></td>`;
      }).join('');
      return `<tr>
        <td class="date-cell" onclick="openDateModal('${day.date}')">${formatDate(day.date)}</td>
        ${cells}
      </tr>`;
    }).join('');
  }

  // ===== Modal =====
  function openDateModal(date) {
    selectedDate = date;
    document.getElementById('modalDate').textContent = formatDate(date);
    document.getElementById('dateModal').classList.remove('hidden');
    renderModalChecklist();
  }
  function closeModal() {
    document.getElementById('dateModal').classList.add('hidden');
    selectedDate = null;
    updateStats();
  }

  async function renderModalChecklist() {
    const data = await apiGetDay(selectedDate);
    const checklistDiv = document.getElementById('modalChecklist');

    checklistDiv.innerHTML = questions.map(q => {
      const v = data[q.id];
      return `
      <div class="modal-checklist-item ${computeRowClass(v)}" id="modal-item-${q.id}">
        <div class="modal-item-question">${q.text}</div>
        <div class="modal-item-buttons">
          <button class="check-btn btn-yes ${v === true ? 'selected' : ''}" onclick="handleModalCheck('${q.id}', true)">${q.yes}</button>
          <button class="check-btn btn-no  ${v === false ? 'selected' : ''}" onclick="handleModalCheck('${q.id}', false)">${q.no}</button>
          <button class="check-btn btn-clear ${v === undefined ? 'selected' : ''}" onclick="handleModalCheck('${q.id}', null)">„Å®„Çä„Åë„Åô</button>
        </div>
      </div>`;
    }).join('');
  }

  async function handleModalCheck(questionId, value) {
    const item = document.getElementById(`modal-item-${questionId}`);
    if (item && item.classList.contains('celebrate')) return;

    if (value === true) playSuccessSound();
    else if (value === false) playSadSound();

    if (item) {
      item.classList.add('celebrate');
      setTimeout(() => item.classList.remove('celebrate'), 600);
    }

    const data = await apiGetDay(selectedDate);

    if (value === null) {
      delete data[questionId];
    } else {
      data[questionId] = value;
    }

    await apiSetDay(selectedDate, data);

    await renderModalChecklist();
    if (selectedDate === currentViewDate) await renderChecklist();
  }

  // ===== Date navigation =====
  function changeDate(days) {
    const cd = new Date(currentViewDate + 'T00:00:00');
    cd.setDate(cd.getDate() + days);
    const y = cd.getFullYear();
    const m = String(cd.getMonth()+1).padStart(2,'0');
    const d = String(cd.getDate()).padStart(2,'0');
    currentViewDate = `${y}-${m}-${d}`;

    const today = getToday();
    const nextBtn = document.getElementById('nextDayBtn');
    if (currentViewDate >= today) {
      currentViewDate = today;
      nextBtn.disabled = true;
    } else {
      nextBtn.disabled = false;
    }
    updateCurrentView();
  }

  async function updateCurrentView() {
    document.getElementById('dateDisplay').textContent = `üìÖ ${formatDate(currentViewDate)}`;
    await renderChecklist();
    await updateStats();
  }

  function goToToday() {
    currentViewDate = getToday();
    document.getElementById('dateDisplay').textContent = `üìÖ ${formatDate(currentViewDate)}`;
    document.getElementById('nextDayBtn').disabled = true;
    updateCurrentView();
  }

  // ===== Logout / Reset =====
  function logout() {
    currentUserName = null;
    currentUserDob = null;
    selectedDate = null;
    currentViewDate = null;
    clearAuth();

    document.getElementById('mainApp').classList.add('hidden');
    document.getElementById('loginScreen').classList.remove('hidden');
    document.getElementById('loginName').value = '';
    document.getElementById('loginDob').value = '';
  }

  function resetAllData() {
    const ok = confirm('„Åç„Çç„Åè„Çí„Åú„Çì„Å∂„Åë„Åó„Åæ„Åô„ÄÇ„ÅÑ„ÅÑÔºü');
    if (!ok) return;
    localStorage.removeItem(STORE_KEY);
    updateCurrentView();
  }

  // ===== App start =====
  async function initAppAfterLogin() {
    document.getElementById('displayName').textContent = currentUserName;
    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('mainApp').classList.remove('hidden');

    currentViewDate = getToday();
    document.getElementById('dateDisplay').textContent = `üìÖ ${formatDate(currentViewDate)}`;
    document.getElementById('nextDayBtn').disabled = true;

    await renderChecklist();
    await updateStats();
  }

  // login
  document.getElementById('loginButton').addEventListener('click', async () => {
    const name = document.getElementById('loginName').value.trim();
    const dob  = document.getElementById('loginDob').value.trim();

    if (!name || !dob) { showError('„Å™„Åæ„Åà„Å®ÁîüÂπ¥ÊúàÊó•„Çí„Å´„ÇÖ„ÅÜ„Çä„Çá„Åè„Åó„Å¶„Å≠'); return; }
    if (!/^\d{8}$/.test(dob)) { showError('ÁîüÂπ¥ÊúàÊó•„ÅØ 8„Åë„ÅüÔºàYYYYMMDDÔºâ„Åß„ÅÑ„Çå„Å¶„Å≠'); return; }

    try {
      const ok = await apiAuth(name, dob);
      if (!ok) { showError('„Å™„Åæ„Åà„ÅãÁîüÂπ¥ÊúàÊó•„Åå„Å°„Åå„ÅÑ„Åæ„Åô'); return; }

      currentUserName = name;
      currentUserDob  = dob;
      saveAuth(name, dob);
      await initAppAfterLogin();
    } catch (e) {
      console.error(e);
      showError('„Ç®„É©„Éº„ÅåÂá∫„Åü„ÇàÔºà„Éñ„É©„Ç¶„Ç∂„Çí„Åï„ÅÑ„Åç„Å©„ÅÜ„Åó„Å¶„Å≠Ôºâ');
    }
  });

  document.getElementById('loginDob').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') document.getElementById('loginButton').click();
  });

  // auto login (if previously saved on this device)
  (function autoLogin(){
    const auth = loadAuth();
    if (!auth) return;
    if (!isAuthorizedLocal(auth.name, auth.dob)) return;

    currentUserName = auth.name;
    currentUserDob  = auth.dob;
    initAppAfterLogin();
  })();

  // expose
  window.handleCheck = handleCheck;
  window.handleModalCheck = handleModalCheck;
  window.logout = logout;
  window.openDateModal = openDateModal;
  window.closeModal = closeModal;
  window.changeDate = changeDate;
  window.goToToday = goToToday;
  window.resetAllData = resetAllData;
</script>
</body>
</html>
