<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>„Åæ„ÅÑ„Å´„Å°„ÅÆ„Åä„ÇÑ„Åè„Åù„Åè„ÉÅ„Çß„ÉÉ„ÇØÔºÅ</title>
  <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    :root{
      --primary:#FF6B9D;
      --secondary:#FFA07A;
      --success:#4ECDC4;
      --warning:#FFD93D;
      --purple:#A78BFA;
      --blue:#60A5FA;
      --bg:#FFF8E7;
      --card-bg:#FFFFFF;
      --shadow:rgba(255,107,157,0.2);
      --neutral:#CBD5E1;
      --neutral-text:#334155;
    }
    body{
      font-family:'M PLUS Rounded 1c',sans-serif;
      background:linear-gradient(135deg,#FFF8E7 0%,#FFE5EC 50%,#E5F3FF 100%);
      min-height:100vh;
      padding:20px;
      position:relative;
      overflow-x:hidden;
    }
    body::before{
      content:'';
      position:fixed;
      top:-50%; left:-50%;
      width:200%; height:200%;
      background:
        radial-gradient(circle at 20% 50%, rgba(255,107,157,0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(78,205,196,0.1) 0%, transparent 50%),
        radial-gradient(circle at 40% 20%, rgba(160,139,250,0.1) 0%, transparent 50%);
      animation:float 20s ease-in-out infinite;
      pointer-events:none;
      z-index:0;
    }
    @keyframes float{
      0%,100%{transform:translate(0,0) rotate(0deg);}
      33%{transform:translate(30px,-30px) rotate(5deg);}
      66%{transform:translate(-20px,20px) rotate(-5deg);}
    }
    .container{ max-width:900px; margin:0 auto; position:relative; z-index:1; }
    .login-container{
      max-width:450px;
      margin:80px auto;
      background:var(--card-bg);
      padding:45px;
      border-radius:30px;
      box-shadow:0 15px 50px var(--shadow);
      border:4px solid var(--primary);
      animation:fadeIn 0.6s ease-out;
    }
    @keyframes fadeIn{ from{opacity:0; transform:scale(0.95);} to{opacity:1; transform:scale(1);} }
    .login-header{ text-align:center; margin-bottom:30px; }
    .login-header .emoji{ font-size:5rem; animation:bounce 2s ease-in-out infinite; }
    .login-header h2{ font-size:2rem; font-weight:900; color:var(--primary); margin-top:10px; }
    @keyframes bounce{
      0%,100%{transform:translateY(0) rotate(0deg);}
      25%{transform:translateY(-10px) rotate(-5deg);}
      75%{transform:translateY(-5px) rotate(5deg);}
    }
    .form-group{ margin-bottom:18px; }
    .form-group label{ display:block; font-size:1.1rem; font-weight:800; color:#333; margin-bottom:8px; }
    .form-group input{
      width:100%;
      padding:14px 18px;
      border:3px solid var(--success);
      border-radius:15px;
      font-size:1.05rem;
      font-family:'M PLUS Rounded 1c',sans-serif;
      font-weight:800;
      transition:all 0.25s ease;
    }
    .form-group input:focus{
      outline:none;
      border-color:var(--primary);
      box-shadow:0 0 0 4px rgba(255,107,157,0.2);
      transform:scale(1.01);
    }
    .login-btn{
      width:100%;
      padding:16px;
      background:linear-gradient(135deg,var(--primary),var(--purple));
      color:white;
      border:none;
      border-radius:15px;
      font-size:1.25rem;
      font-weight:900;
      font-family:'M PLUS Rounded 1c',sans-serif;
      cursor:pointer;
      transition:all 0.25s ease;
      box-shadow:0 5px 20px rgba(255,107,157,0.4);
      margin-top:8px;
    }
    .login-btn:hover{ transform:translateY(-2px); box-shadow:0 8px 25px rgba(255,107,157,0.5); }
    .error-message{ color:#ff4444; font-weight:800; text-align:center; margin-top:12px; display:none; }

    .user-info{
      display:flex; justify-content:space-between; align-items:center;
      background:var(--card-bg);
      padding:14px 22px;
      border-radius:15px;
      margin-bottom:18px;
      box-shadow:0 5px 20px var(--shadow);
      border:3px solid var(--success);
      flex-wrap:wrap;
      gap:10px;
    }
    .user-name{ font-size:1.2rem; font-weight:800; color:var(--primary); }
    .user-buttons{ display:flex; gap:10px; flex-wrap:wrap; }
    .logout-btn,.home-btn,.reset-btn{
      padding:10px 18px;
      border:none; border-radius:10px;
      font-size:1rem; font-weight:800;
      font-family:'M PLUS Rounded 1c',sans-serif;
      cursor:pointer;
      transition:all 0.25s ease;
    }
    .logout-btn{ background:var(--warning); color:#333; }
    .logout-btn:hover{ transform:scale(1.04); box-shadow:0 3px 10px rgba(255,215,61,0.5); }
    .home-btn{ background:linear-gradient(135deg,var(--purple),var(--blue)); color:white; }
    .home-btn:hover{ transform:scale(1.04); box-shadow:0 3px 10px rgba(160,139,250,0.5); }
    .reset-btn{ background:linear-gradient(135deg,#94A3B8,#CBD5E1); color:#0f172a; }
    .reset-btn:hover{ transform:scale(1.04); box-shadow:0 3px 10px rgba(148,163,184,0.5); }

    .header{ text-align:center; margin:22px 0 24px; }
    .header .emoji{ font-size:4rem; display:inline-block; animation:bounce 2s ease-in-out infinite; }
    .header h1{
      font-size:2.6rem; font-weight:900;
      background:linear-gradient(135deg,var(--primary),var(--purple),var(--success));
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      margin-top:8px;
    }
    .date-display{
      background:var(--card-bg);
      padding:18px;
      border-radius:20px;
      box-shadow:0 8px 30px var(--shadow);
      margin-bottom:24px;
      display:flex; justify-content:space-between; align-items:center;
      font-size:1.3rem; font-weight:800; color:var(--primary);
      border:3px solid var(--warning);
    }
    .date-nav-btn{
      padding:10px 16px;
      background:linear-gradient(135deg,var(--success),var(--blue));
      color:white;
      border:none; border-radius:15px;
      font-size:0.95rem; font-weight:800;
      font-family:'M PLUS Rounded 1c',sans-serif;
      cursor:pointer;
      transition:all 0.25s ease;
      box-shadow:0 3px 10px rgba(78,205,196,0.3);
    }
    .date-nav-btn:hover{ transform:translateY(-2px); box-shadow:0 5px 15px rgba(78,205,196,0.4); }
    .date-nav-btn:disabled{ opacity:0.5; cursor:not-allowed; }
    .current-date{ flex:1; text-align:center; }

    .checklist-card{
      background:var(--card-bg);
      padding:26px;
      border-radius:25px;
      box-shadow:0 10px 40px var(--shadow);
      margin-bottom:22px;
      border:4px solid var(--success);
    }
    .checklist-item{
      display:flex; align-items:center; justify-content:space-between;
      padding:18px; margin-bottom:12px;
      border-radius:15px;
      background:linear-gradient(135deg, rgba(255,107,157,0.05), rgba(78,205,196,0.05));
      border:2px solid transparent;
      transition:all 0.25s ease;
    }
    .checklist-item:hover{ transform:translateX(4px); border-color:var(--primary); box-shadow:0 5px 15px rgba(255,107,157,0.2); }
    .checklist-item.checked-yes{ background:linear-gradient(135deg, rgba(78,205,196,0.2), rgba(96,165,250,0.2)); border-color:var(--success); }
    .checklist-item.checked-no{ background:linear-gradient(135deg, rgba(255,215,61,0.2), rgba(255,160,122,0.2)); border-color:var(--warning); }
    .item-question{ font-size:1.18rem; font-weight:800; color:#333; flex:1; }
    .item-buttons{ display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; }

    .check-btn{
      padding:11px 18px;
      border:none; border-radius:50px;
      font-size:1.02rem; font-weight:800;
      font-family:'M PLUS Rounded 1c',sans-serif;
      cursor:pointer;
      transition:all 0.25s ease;
      box-shadow:0 4px 15px rgba(0,0,0,0.1);
      white-space:nowrap;
    }
    .check-btn:hover{ transform:translateY(-2px) scale(1.03); box-shadow:0 6px 20px rgba(0,0,0,0.2); }
    .btn-yes{ background:linear-gradient(135deg,var(--success),var(--blue)); color:white; }
    .btn-yes.selected{ background:var(--success); box-shadow:0 0 0 4px rgba(78,205,196,0.3); }
    .btn-no{ background:linear-gradient(135deg,var(--warning),var(--secondary)); color:#333; }
    .btn-no.selected{ background:var(--warning); box-shadow:0 0 0 4px rgba(255,215,61,0.3); }
    .btn-clear{ background:linear-gradient(135deg,var(--neutral),#E2E8F0); color:var(--neutral-text); }
    .btn-clear.selected{ background:#E2E8F0; box-shadow:0 0 0 4px rgba(203,213,225,0.7); }

    .celebrate{ animation:celebrate 0.6s ease-out; }
    @keyframes celebrate{
      0%,100%{transform:scale(1);}
      25%{transform:scale(1.07) rotate(-4deg);}
      75%{transform:scale(1.07) rotate(4deg);}
    }

    .stats-card{
      background:var(--card-bg);
      padding:26px;
      border-radius:25px;
      box-shadow:0 10px 40px var(--shadow);
      margin-bottom:22px;
      border:4px solid var(--purple);
    }
    .stats-header{ font-size:1.7rem; font-weight:900; color:var(--purple); margin-bottom:20px; text-align:center; }
    .progress-bar{
      background:#E2E8F0;
      height:40px; border-radius:25px; overflow:hidden;
      margin-bottom:26px; position:relative;
      box-shadow:inset 0 2px 8px rgba(0,0,0,0.1);
    }
    .progress-fill{
      background:linear-gradient(135deg,var(--success),var(--blue),var(--purple));
      height:100%; transition:width 0.6s ease;
      display:flex; align-items:center; justify-content:center;
      color:white; font-size:1.05rem; font-weight:900;
      border-radius:25px;
    }
    .trophy{ font-size:1.6rem; font-weight:900; text-align:center; margin:16px 0; }
    .stats-details{
      display:flex; justify-content:space-around; flex-wrap:wrap; gap:14px;
      margin-top:20px;
    }
    .stat-item{
      background:linear-gradient(135deg, rgba(160,139,250,0.1), rgba(96,165,250,0.1));
      padding:18px; border-radius:15px; text-align:center; flex:1; min-width:130px;
      border:2px solid var(--purple);
    }
    .stat-label{ font-size:0.95rem; font-weight:800; color:#555; margin-bottom:6px; }
    .stat-value{ font-size:1.6rem; font-weight:900; color:var(--purple); }

    .history-card{
      background:var(--card-bg);
      padding:26px;
      border-radius:25px;
      box-shadow:0 10px 40px var(--shadow);
      border:4px solid var(--blue);
    }
    .history-header{ font-size:1.7rem; font-weight:900; color:var(--blue); margin-bottom:20px; text-align:center; }
    .history-table-wrapper{ overflow-x:auto; }
    .history-table{
      width:100%; border-collapse:collapse;
      font-size:0.9rem; font-weight:800;
    }
    .history-table th, .history-table td{
      padding:12px 10px; text-align:center;
      border:2px solid #E2E8F0;
    }
    .history-table thead{ background:linear-gradient(135deg, var(--blue), var(--purple)); color:white; }
    .history-table tbody tr:nth-child(even){ background:rgba(96,165,250,0.05); }
    .history-table tbody tr:hover{ background:rgba(96,165,250,0.15); }
    .check-mark{
      display:inline-block; font-size:1.1rem; font-weight:900;
      padding:4px 8px; border-radius:8px;
    }
    .check-mark.yes{ background:rgba(78,205,196,0.3); color:var(--success); }
    .check-mark.no{ background:rgba(255,215,61,0.3); color:#d97706; }
    .date-cell{ cursor:pointer; color:var(--primary); font-weight:900; text-decoration:underline; }
    .date-cell:hover{ color:var(--purple); }

    .modal{
      position:fixed; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,0.5); display:flex; justify-content:center; align-items:center;
      z-index:1000; padding:20px;
    }
    .modal.hidden{ display:none; }
    .modal-content{
      background:var(--card-bg);
      padding:30px; border-radius:25px;
      max-width:700px; width:100%;
      max-height:80vh; overflow-y:auto;
      box-shadow:0 15px 60px rgba(0,0,0,0.3);
      border:4px solid var(--primary);
    }
    .modal-header{
      display:flex; justify-content:space-between; align-items:center;
      margin-bottom:22px; padding-bottom:14px; border-bottom:3px solid var(--primary);
    }
    .modal-title{ font-size:1.6rem; font-weight:900; color:var(--primary); }
    .modal-close-btn{
      background:var(--warning); color:#333;
      border:none; border-radius:50%;
      width:38px; height:38px;
      font-size:1.3rem; font-weight:900;
      cursor:pointer;
      transition:all 0.2s ease;
    }
    .modal-close-btn:hover{ transform:scale(1.08); background:var(--secondary); }
    .modal-checklist-item{
      display:flex; flex-direction:column; gap:10px;
      padding:16px; margin-bottom:12px; border-radius:15px;
      background:linear-gradient(135deg, rgba(255,107,157,0.05), rgba(78,205,196,0.05));
      border:2px solid transparent;
      transition:all 0.25s ease;
    }
    .modal-checklist-item.checked-yes{ background:linear-gradient(135deg, rgba(78,205,196,0.2), rgba(96,165,250,0.2)); border-color:var(--success); }
    .modal-checklist-item.checked-no{ background:linear-gradient(135deg, rgba(255,215,61,0.2), rgba(255,160,122,0.2)); border-color:var(--warning); }
    .modal-item-question{ font-size:1.08rem; font-weight:800; color:#333; }
    .modal-item-buttons{ display:flex; gap:8px; flex-wrap:wrap; }

    .hidden{ display:none; }

    @media (max-width: 768px){
      .header h1{ font-size:2rem; }
      .date-display{ flex-direction:column; gap:12px; }
      .checklist-item{ flex-direction:column; align-items:flex-start; gap:12px; }
      .item-buttons{ width:100%; justify-content:flex-start; }
      .stats-details{ flex-direction:column; }
      .stat-item{ min-width:100%; }
      .history-table{ font-size:0.8rem; }
      .history-table th, .history-table td{ padding:8px 6px; }
      .modal-content{ padding:22px; }
      .user-info{ flex-direction:column; align-items:flex-start; }
      .user-buttons{ width:100%; }
    }
  </style>
</head>
<body>

<!-- Login Screen -->
<div id="loginScreen">
  <div class="login-container">
    <div class="login-header">
      <div class="emoji">üåü</div>
      <h2>„Åæ„ÅÑ„Å´„Å°„ÅÆ„Åä„ÇÑ„Åè„Åù„Åè„ÉÅ„Çß„ÉÉ„ÇØÔºÅ</h2>
    </div>
    <div class="form-group">
      <label for="loginName">„Å™„Åæ„Åà</label>
      <input type="text" id="loginName" placeholder="„Å™„Åæ„Åà„Çí„ÅÑ„Çå„Å¶„Å≠" />
    </div>
    <div class="form-group">
      <label for="loginDob">ÁîüÂπ¥ÊúàÊó•ÔºàYYYYMMDDÔºâ</label>
      <input type="text" id="loginDob" placeholder="20170101" maxlength="8" />
    </div>
    <button class="login-btn" id="loginButton">„É≠„Ç∞„Ç§„É≥</button>
    <div id="errorMessage" class="error-message"></div>
  </div>
</div>

<!-- Main App -->
<div id="mainApp" class="hidden">
  <div class="container">
    <div class="user-info">
      <div class="user-name">üë§ <span id="displayName"></span></div>
      <div class="user-buttons">
        <button class="home-btn" onclick="goToToday()">„Åç„Çá„ÅÜ„Å´„ÇÇ„Å©„Çã</button>
        <button class="reset-btn" onclick="resetAllData()">„É™„Çª„ÉÉ„Éà</button>
        <button class="logout-btn" onclick="logout()">„É≠„Ç∞„Ç¢„Ç¶„Éà</button>
      </div>
    </div>

    <div class="header">
      <div class="emoji">üéâ</div>
      <h1>„Åæ„ÅÑ„Å´„Å°„ÅÆ„Åä„ÇÑ„Åè„Åù„Åè</h1>
    </div>

    <div class="date-display">
      <button class="date-nav-btn" onclick="changeDate(-1)">‚óÄ „Åæ„Åà„ÅÆ„Å≤</button>
      <div class="current-date" id="dateDisplay">üìÖ 2025-01-01</div>
      <button class="date-nav-btn" id="nextDayBtn" onclick="changeDate(1)" disabled>„Å§„Åé„ÅÆ„Å≤ ‚ñ∂</button>
    </div>

    <div class="checklist-card" id="checklistCard"></div>

    <div class="stats-card">
      <div class="stats-header">üìä „Åì„Çì„Åó„ÇÖ„ÅÜ„ÅÆ„Åå„Çì„Å∞„Çä</div>
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill">0%</div>
      </div>
      <div id="trophyDisplay"></div>
      <div class="stats-details">
        <div class="stat-item">
          <div class="stat-label">„Åß„Åç„Åü</div>
          <div class="stat-value" id="statYes">0</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">„Åß„Åç„Å™„Åã„Å£„Åü</div>
          <div class="stat-value" id="statNo">0</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">„Åç„Çç„Åè</div>
          <div class="stat-value" id="statTotal">0</div>
        </div>
      </div>
    </div>

    <div class="history-card">
      <div class="history-header">üìÖ 1„Åó„ÇÖ„ÅÜ„Åã„Çì„ÅÆ„Åç„Çç„Åè</div>
      <div class="history-table-wrapper">
        <table class="history-table">
          <thead>
            <tr id="historyHeaderRow"></tr>
          </thead>
          <tbody id="historyBody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Date Modal -->
<div id="dateModal" class="modal hidden" onclick="if(event.target===this) closeModal()">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title">üìÖ <span id="modalDate"></span></div>
      <button class="modal-close-btn" onclick="closeModal()">√ó</button>
    </div>
    <div id="modalChecklist"></div>
  </div>
</div>

<script>
  // ===== Constants =====
  const STORE_KEY = 'daily_checklist_data';
  const AUTH_KEY = 'checklist_auth';
  const AUTH_DB = [
    { name: '„Åì„ÅÜ„Åô„Åë', dob: '20191113' },
    { name: '„Åü„Åã„ÅÇ„Åç', dob: '19890607' },
    { name: '„Å°„Å™„Å§',   dob: '19891011' }
  ];
  const questions = [
    { id: 'toilet',    text: '„Åò„Å∂„Çì„Åß„Éà„Ç§„É¨„Å´„ÅÑ„Åë„ÅüÔºü',             yes: '„ÅÑ„Åë„Åü‚úÖ', no: '„ÅÑ„Åë„Å™„Åã„Å£„Åü‚ùå' },
    { id: 'change',    text: '„Çà„ÅÜ„Åµ„Åè„Çí„Åç„Åå„Åà„Çâ„Çå„ÅüÔºü',             yes: '„Åç„Åå„Åà„Åü‚úÖ', no: '„Åç„Åå„Åà„Å™„Åã„Å£„Åü‚ùå' },
    { id: 'breakfast', text: '„ÅÇ„Åï„Åî„ÅØ„Çì„Çí„Åü„Åπ„Çâ„Çå„ÅüÔºü',             yes: '„Åü„Åπ„Åü‚úÖ', no: '„Åü„Åπ„Å™„Åã„Å£„Åü‚ùå' },
    { id: 'study',     text: '„ÅÇ„Åï„ÅÆ„Åå„Åè„Åó„ÇÖ„ÅÜ„Çí„Åó„ÅüÔºü',             yes: '„Åó„Åü‚úÖ', no: '„Åó„Å™„Åã„Å£„Åü‚ùå' },
    { id: 'jungle',    text: '„Ç∏„É£„É≥„Ç∞„É´„Ç∏„É†„Å´„ÅÆ„Åº„Çå„ÅüÔºü',           yes: '„ÅÆ„Åº„Çå„Åü‚úÖ', no: '„ÅÆ„Åº„Çå„Å™„Åã„Å£„Åü‚ùå' },
    { id: 'teacher',   text: '„Åõ„Çì„Åõ„ÅÑ„ÇÑ„Åä„Å®„ÅÜ„Åï„Çì„ÅÆ„Åä„ÅØ„Å™„Åó„Çí„Åç„Åë„ÅüÔºü', yes: '„Åç„Åë„Åü‚úÖ', no: '„Åç„Åë„Å™„Åã„Å£„Åü‚ùå' },
    { id: 'friends',   text: '„Åä„Å®„ÇÇ„Å†„Å°„ÇÑ„Åä„Å≠„Åà„Å°„ÇÉ„Çì„Å®„Å™„Åã„Çà„Åè„Åß„Åç„ÅüÔºü', yes: '„Åß„Åç„Åü‚úÖ', no: '„Åß„Åç„Å™„Åã„Å£„Åü‚ùå' }
  ];

  let currentUserName = null;
  let currentUserDob = null;
  let selectedDate = null;
  let currentViewDate = null;

  // ===== Audio Context („Çø„Éñ„É¨„ÉÉ„ÉàÂØæÂøú‰øÆÊ≠£) =====
  let audioCtx = null;
  let isAudioInitialized = false;

  // AudioContext„ÇíÂàùÊúüÂåñ„Åô„ÇãÈñ¢Êï∞
  function initAudioContext() {
    if (!audioCtx) {
      try {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        console.log('AudioContext created:', audioCtx.state);
      } catch (e) {
        console.error('Failed to create AudioContext:', e);
        return false;
      }
    }
    
    // AudioContext„Ååsuspended„ÅÆÂ†¥Âêà„ÅØresume„Åô„Çã
    if (audioCtx.state === 'suspended') {
      audioCtx.resume().then(() => {
        console.log('AudioContext resumed:', audioCtx.state);
        isAudioInitialized = true;
      }).catch(e => {
        console.error('Failed to resume AudioContext:', e);
      });
    } else {
      isAudioInitialized = true;
    }
    
    return true;
  }

  // Èü≥„ÇíÂÜçÁîü„Åô„ÇãÂâç„Å´ÂøÖ„ÅöAudioContext„ÇíÁ¢∫Ë™ç„Åó„Å¶resume„Åô„Çã
  async function ensureAudioReady() {
    if (!audioCtx) {
      initAudioContext();
    }
    
    if (audioCtx && audioCtx.state === 'suspended') {
      try {
        await audioCtx.resume();
        console.log('AudioContext resumed before playback');
      } catch (e) {
        console.error('Failed to resume audio:', e);
      }
    }
  }

  function beep(freq, duration) {
    if (!audioCtx) {
      console.warn('AudioContext not initialized');
      return;
    }

    try {
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.connect(gain);
      gain.connect(audioCtx.destination);

      osc.frequency.value = freq;
      osc.type = 'sine';

      gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);

      osc.start(audioCtx.currentTime);
      osc.stop(audioCtx.currentTime + duration);
    } catch (e) {
      console.error('Failed to play beep:', e);
    }
  }

  async function playSuccessSound() {
    await ensureAudioReady();
    beep(523.25, 0.15);
    setTimeout(() => beep(659.25, 0.15), 100);
    setTimeout(() => beep(783.99, 0.3), 200);
  }

  async function playSadSound() {
    await ensureAudioReady();
    beep(392, 0.2);
    setTimeout(() => beep(349.23, 0.3), 150);
  }

  // ===== Auth =====
  function isAuthorizedLocal(name, dob) {
    return AUTH_DB.some(u => u.name === name && u.dob === dob);
  }
  async function apiAuth(name, dob) {
    await new Promise(r => setTimeout(r, 300));
    return isAuthorizedLocal(name, dob);
  }
  function saveAuth(name, dob) {
    localStorage.setItem(AUTH_KEY, JSON.stringify({ name, dob }));
  }
  function loadAuth() {
    const str = localStorage.getItem(AUTH_KEY);
    if (!str) return null;
    try { return JSON.parse(str); } catch { return null; }
  }
  function clearAuth() {
    localStorage.removeItem(AUTH_KEY);
  }

  // ===== Data =====
  function getUserStoreKey() {
    return `${STORE_KEY}_${currentUserName}_${currentUserDob}`;
  }
  function loadStore() {
    const key = getUserStoreKey();
    const str = localStorage.getItem(key);
    if (!str) return {};
    try { return JSON.parse(str); } catch { return {}; }
  }
  function saveStore(data) {
    const key = getUserStoreKey();
    localStorage.setItem(key, JSON.stringify(data));
  }

  async function apiGetDay(date) {
    const all = loadStore();
    return all[date] || {};
  }
  async function apiSetDay(date, data) {
    const all = loadStore();
    all[date] = data;
    saveStore(all);
  }

  function getToday() {
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${dd}`;
  }
  function formatDate(dateStr) {
    const d = new Date(dateStr+'T00:00:00');
    const m = d.getMonth()+1;
    const dd = d.getDate();
    const dow = ['Êó•','Êúà','ÁÅ´','Ê∞¥','Êú®','Èáë','Âúü'][d.getDay()];
    return `${m}Êúà${dd}Êó•Ôºà${dow}Ôºâ`;
  }

  // ===== Error =====
  function showError(msg) {
    const el = document.getElementById('errorMessage');
    el.textContent = msg;
    el.style.display = 'block';
    setTimeout(() => { el.style.display='none'; }, 3000);
  }

  // ===== Render checklist =====
  async function renderChecklist() {
    const data = await apiGetDay(currentViewDate);
    const card = document.getElementById('checklistCard');

    card.innerHTML = questions.map(q => {
      const v = data[q.id];
      return `
      <div class="checklist-item ${computeRowClass(v)}" id="item-${q.id}">
        <div class="item-question">${q.text}</div>
        <div class="item-buttons">
          <button class="check-btn btn-yes ${v === true ? 'selected' : ''}" onclick="handleCheck('${q.id}', true)">${q.yes}</button>
          <button class="check-btn btn-no  ${v === false ? 'selected' : ''}" onclick="handleCheck('${q.id}', false)">${q.no}</button>
          <button class="check-btn btn-clear ${v === undefined ? 'selected' : ''}" onclick="handleCheck('${q.id}', null)">„Å®„Çä„Åë„Åô</button>
        </div>
      </div>`;
    }).join('');
  }

  function computeRowClass(val) {
    if (val === true) return 'checked-yes';
    if (val === false) return 'checked-no';
    return '';
  }

  async function handleCheck(questionId, value) {
    // ÊúÄÂàù„ÅÆ„Éú„Çø„É≥„Çø„ÉÉ„Éó„ÅßAudioContext„ÇíÂàùÊúüÂåñ
    if (!isAudioInitialized) {
      initAudioContext();
    }

    const item = document.getElementById(`item-${questionId}`);
    if (item && item.classList.contains('celebrate')) return;

    if (value === true) await playSuccessSound();
    else if (value === false) await playSadSound();

    if (item) {
      item.classList.add('celebrate');
      setTimeout(() => item.classList.remove('celebrate'), 600);
    }

    const data = await apiGetDay(currentViewDate);

    if (value === null) {
      delete data[questionId];
    } else {
      data[questionId] = value;
    }

    await apiSetDay(currentViewDate, data);

    await renderChecklist();
    await updateStats();
  }

  // ===== Stats =====
  async function updateStats() {
    const weekData = await getWeekData();

    const stats = {
      yes: 0,
      no: 0,
      total: 0,
      percentage: 0
    };

    weekData.forEach(day => {
      const d = day.data || {};
      Object.values(d).forEach(v => {
        if (v === true) stats.yes++;
        else if (v === false) stats.no++;
      });
    });

    stats.total = stats.yes + stats.no;
    if (stats.total > 0) {
      stats.percentage = Math.round((stats.yes / stats.total) * 100);
    }

    document.getElementById('statYes').textContent = stats.yes;
    document.getElementById('statNo').textContent = stats.no;
    document.getElementById('statTotal').textContent = stats.total;

    const progressFill = document.getElementById('progressFill');
    progressFill.style.width = `${stats.percentage}%`;
    progressFill.textContent = `${stats.percentage}%`;

    const trophyDisplay = document.getElementById('trophyDisplay');
    if (stats.percentage >= 80) trophyDisplay.innerHTML = '<div class="trophy">üèÜ „Åô„Åî„ÅÑÔºÅ„Çà„Åè„Åå„Çì„Å∞„Å£„Åü„Å≠ÔºÅ</div>';
    else if (stats.percentage >= 60) trophyDisplay.innerHTML = '<div class="trophy">‚≠ê „ÅÑ„ÅÑ„Å°„Çá„ÅÜ„Åó„Å†„Å≠ÔºÅ</div>';
    else trophyDisplay.innerHTML = '<div class="trophy">üí™ „Åå„Çì„Å∞„Çç„ÅÜÔºÅ</div>';

    renderHistoryHeader();
    renderHistory(weekData);
  }

  async function getWeekData() {
    const result = [];
    const today = new Date(currentViewDate + 'T00:00:00');

    for (let i = 6; i >= 0; i--) {
      const d = new Date(today);
      d.setDate(d.getDate() - i);
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      const dateStr = `${y}-${m}-${dd}`;
      const data = await apiGetDay(dateStr);
      result.push({ date: dateStr, data });
    }

    return result;
  }

  function renderHistoryHeader() {
    const row = document.getElementById('historyHeaderRow');
    const headers = ['Êó•„Å•„Åë', ...questions.map(q => {
      if (q.id === 'toilet') return '„Éà„Ç§„É¨';
      if (q.id === 'change') return 'ÁùÄ„Åå„Åà';
      if (q.id === 'breakfast') return '„ÅÇ„Åï„Åî„ÅØ„Çì';
      if (q.id === 'study') return '„ÅÇ„Åï„Åå„Åè„Åó„ÇÖ„ÅÜ';
      if (q.id === 'jungle') return '„Ç∏„É£„É≥„Ç∞„É´„Ç∏„É†';
      if (q.id === 'teacher') return '„Åä„ÅØ„Å™„Åó';
      if (q.id === 'friends') return '„Åä„Å®„ÇÇ„Å†„Å°';
      return q.id;
    })];
    row.innerHTML = headers.map(h => `<th>${h}</th>`).join('');
  }

  function renderHistory(weekData) {
    const tbody = document.getElementById('historyBody');
    tbody.innerHTML = weekData.map(day => {
      const cells = questions.map(q => {
        const v = day.data ? day.data[q.id] : undefined;
        if (v === undefined) return `<td>-</td>`;
        return `<td><span class="check-mark ${v ? 'yes' : 'no'}">${v ? '‚≠ï' : '‚ùå'}</span></td>`;
      }).join('');
      return `<tr>
        <td class="date-cell" onclick="openDateModal('${day.date}')">${formatDate(day.date)}</td>
        ${cells}
      </tr>`;
    }).join('');
  }

  // ===== Modal =====
  function openDateModal(date) {
    selectedDate = date;
    document.getElementById('modalDate').textContent = formatDate(date);
    document.getElementById('dateModal').classList.remove('hidden');
    renderModalChecklist();
  }
  function closeModal() {
    document.getElementById('dateModal').classList.add('hidden');
    selectedDate = null;
    updateStats();
  }

  async function renderModalChecklist() {
    const data = await apiGetDay(selectedDate);
    const checklistDiv = document.getElementById('modalChecklist');

    checklistDiv.innerHTML = questions.map(q => {
      const v = data[q.id];
      return `
      <div class="modal-checklist-item ${computeRowClass(v)}" id="modal-item-${q.id}">
        <div class="modal-item-question">${q.text}</div>
        <div class="modal-item-buttons">
          <button class="check-btn btn-yes ${v === true ? 'selected' : ''}" onclick="handleModalCheck('${q.id}', true)">${q.yes}</button>
          <button class="check-btn btn-no  ${v === false ? 'selected' : ''}" onclick="handleModalCheck('${q.id}', false)">${q.no}</button>
          <button class="check-btn btn-clear ${v === undefined ? 'selected' : ''}" onclick="handleModalCheck('${q.id}', null)">„Å®„Çä„Åë„Åô</button>
        </div>
      </div>`;
    }).join('');
  }

  async function handleModalCheck(questionId, value) {
    // „É¢„Éº„ÉÄ„É´ÂÜÖ„Åß„ÇÇÊúÄÂàù„ÅÆ„Çø„ÉÉ„Éó„ÅßAudioContext„ÇíÂàùÊúüÂåñ
    if (!isAudioInitialized) {
      initAudioContext();
    }

    const item = document.getElementById(`modal-item-${questionId}`);
    if (item && item.classList.contains('celebrate')) return;

    if (value === true) await playSuccessSound();
    else if (value === false) await playSadSound();

    if (item) {
      item.classList.add('celebrate');
      setTimeout(() => item.classList.remove('celebrate'), 600);
    }

    const data = await apiGetDay(selectedDate);

    if (value === null) {
      delete data[questionId];
    } else {
      data[questionId] = value;
    }

    await apiSetDay(selectedDate, data);

    await renderModalChecklist();
    if (selectedDate === currentViewDate) await renderChecklist();
  }

  // ===== Date navigation =====
  function changeDate(days) {
    const cd = new Date(currentViewDate + 'T00:00:00');
    cd.setDate(cd.getDate() + days);
    const y = cd.getFullYear();
    const m = String(cd.getMonth()+1).padStart(2,'0');
    const d = String(cd.getDate()).padStart(2,'0');
    currentViewDate = `${y}-${m}-${d}`;

    const today = getToday();
    const nextBtn = document.getElementById('nextDayBtn');
    if (currentViewDate >= today) {
      currentViewDate = today;
      nextBtn.disabled = true;
    } else {
      nextBtn.disabled = false;
    }
    updateCurrentView();
  }

  async function updateCurrentView() {
    document.getElementById('dateDisplay').textContent = `üìÖ ${formatDate(currentViewDate)}`;
    await renderChecklist();
    await updateStats();
  }

  function goToToday() {
    currentViewDate = getToday();
    document.getElementById('dateDisplay').textContent = `üìÖ ${formatDate(currentViewDate)}`;
    document.getElementById('nextDayBtn').disabled = true;
    updateCurrentView();
  }

  // ===== Logout / Reset =====
  function logout() {
    currentUserName = null;
    currentUserDob = null;
    selectedDate = null;
    currentViewDate = null;
    clearAuth();

    document.getElementById('mainApp').classList.add('hidden');
    document.getElementById('loginScreen').classList.remove('hidden');
    document.getElementById('loginName').value = '';
    document.getElementById('loginDob').value = '';
  }

  function resetAllData() {
    const ok = confirm('„Åç„Çç„Åè„Çí„Åú„Çì„Å∂„Åë„Åó„Åæ„Åô„ÄÇ„ÅÑ„ÅÑÔºü');
    if (!ok) return;
    localStorage.removeItem(getUserStoreKey());
    updateCurrentView();
  }

  // ===== App start =====
  async function initAppAfterLogin() {
    document.getElementById('displayName').textContent = currentUserName;
    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('mainApp').classList.remove('hidden');

    currentViewDate = getToday();
    document.getElementById('dateDisplay').textContent = `üìÖ ${formatDate(currentViewDate)}`;
    document.getElementById('nextDayBtn').disabled = true;

    await renderChecklist();
    await updateStats();
  }

  // login
  document.getElementById('loginButton').addEventListener('click', async () => {
    // „É≠„Ç∞„Ç§„É≥„Éú„Çø„É≥„Åß„ÇÇAudioContext„ÇíÂàùÊúüÂåñÔºàÊúÄÂàù„ÅÆ„É¶„Éº„Ç∂„ÉºÊìç‰ΩúÔºâ
    if (!isAudioInitialized) {
      initAudioContext();
    }

    const name = document.getElementById('loginName').value.trim();
    const dob  = document.getElementById('loginDob').value.trim();

    if (!name || !dob) { showError('„Å™„Åæ„Åà„Å®ÁîüÂπ¥ÊúàÊó•„Çí„Å´„ÇÖ„ÅÜ„Çä„Çá„Åè„Åó„Å¶„Å≠'); return; }
    if (!/^\d{8}$/.test(dob)) { showError('ÁîüÂπ¥ÊúàÊó•„ÅØ 8„Åë„ÅüÔºàYYYYMMDDÔºâ„Åß„ÅÑ„Çå„Å¶„Å≠'); return; }

    try {
      const ok = await apiAuth(name, dob);
      if (!ok) { showError('„Å™„Åæ„Åà„ÅãÁîüÂπ¥ÊúàÊó•„Åå„Å°„Åå„ÅÑ„Åæ„Åô'); return; }

      currentUserName = name;
      currentUserDob  = dob;
      saveAuth(name, dob);
      await initAppAfterLogin();
    } catch (e) {
      console.error(e);
      showError('„Ç®„É©„Éº„ÅåÂá∫„Åü„ÇàÔºà„Éñ„É©„Ç¶„Ç∂„Çí„Åï„ÅÑ„Åç„Å©„ÅÜ„Åó„Å¶„Å≠Ôºâ');
    }
  });

  document.getElementById('loginDob').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') document.getElementById('loginButton').click();
  });

  // auto login (if previously saved on this device)
  (function autoLogin(){
    const auth = loadAuth();
    if (!auth) return;
    if (!isAuthorizedLocal(auth.name, auth.dob)) return;

    currentUserName = auth.name;
    currentUserDob  = auth.dob;
    initAppAfterLogin();
  })();

  // expose
  window.handleCheck = handleCheck;
  window.handleModalCheck = handleModalCheck;
  window.logout = logout;
  window.openDateModal = openDateModal;
  window.closeModal = closeModal;
  window.changeDate = changeDate;
  window.goToToday = goToToday;
  window.resetAllData = resetAllData;
</script>
</body>
</html>